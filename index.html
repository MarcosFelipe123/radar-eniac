<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar Chart Eniac - Mechatronics Project</title>
    
    <script src="https://www.gstatic.com/external_hosted/datastudio-components/dscc@latest.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: transparent !important; /* Essencial para transparência no Looker */
            font-family: sans-serif;
        }
        #viz-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .axis-line { stroke: #999; stroke-width: 1px; }
        .grid-line { stroke: #CDCDCD; stroke-width: 1px; stroke-dasharray: 4,4; fill: none; }
        .legend-text { font-size: 12px; fill: #333; font-weight: bold; }
    </style>
</head>
<body>
    <div id="viz-container"></div>

    <script>
        // Função principal de renderização
        function drawViz(data) {
            // Limpa o container antes de redesenhar
            d3.select('#viz-container').selectAll('*').remove();

            // Verifica se há dados suficientes
            if (!data || !data.tables || !data.tables.DEFAULT || data.tables.DEFAULT.length === 0) {
                return; 
            }

            const rows = data.tables.DEFAULT;
            const fields = data.fields;

            // Configurações de Dimensões
            const width = window.innerWidth;
            const height = window.innerHeight;
            const margin = 60;
            const radius = Math.min(width, height) / 2 - margin;

            // Seleção de Dimensões (Eixos) e Métricas
            const axisLabels = rows.map(d => d[fields.concepts[0].id]);
            const totalAxes = axisLabels.length;
            const angleSlice = (Math.PI * 2) / totalAxes;

            // Escala (Máximo valor entre todas as métricas)
            const maxValue = d3.max(rows, d => d3.max(fields.metrics.map(m => d[m.id]))) || 100;
            const rScale = d3.scaleLinear().range([0, radius]).domain([0, maxValue]);

            // Criação do SVG
            const svg = d3.select('#viz-container')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .append('g')
                .attr('transform', `translate(${width / 2}, ${height / 2})`);

            // --- DESENHO DO GRID (Níveis) ---
            const levels = 5;
            for (let i = 0; i < levels; i++) {
                const levelFactor = radius * ((i + 1) / levels);
                svg.append("circle")
                    .attr("class", "grid-line")
                    .attr("r", levelFactor);
            }

            // --- DESENHO DOS EIXOS ---
            const axis = svg.selectAll(".axis")
                .data(axisLabels)
                .enter().append("g");

            axis.append("line")
                .attr("class", "axis-line")
                .attr("x1", 0).attr("y1", 0)
                .attr("x2", (d, i) => rScale(maxValue) * Math.cos(angleSlice * i - Math.PI / 2))
                .attr("y2", (d, i) => rScale(maxValue) * Math.sin(angleSlice * i - Math.PI / 2));

            axis.append("text")
                .attr("class", "legend-text")
                .attr("text-anchor", "middle")
                .attr("dy", "0.35em")
                .attr("x", (d, i) => rScale(maxValue * 1.15) * Math.cos(angleSlice * i - Math.PI / 2))
                .attr("y", (d, i) => rScale(maxValue * 1.15) * Math.sin(angleSlice * i - Math.PI / 2))
                .text(d => d);

            // --- DESENHO DAS ÁREAS (Métricas) ---
            const radarLine = d3.lineRadial()
                .radius(d => rScale(d.value))
                .angle((d, i) => i * angleSlice)
                .curve(d3.curveLinearClosed);

            fields.metrics.forEach((metric, idx) => {
                const metricData = rows.map(r => ({ value: r[metric.id] }));
                const color = d3.schemeCategory10[idx % 10]; // Cores automáticas para múltiplas métricas

                const blobWrapper = svg.append("g");

                // Área preenchida
                blobWrapper.append("path")
                    .attr("d", radarLine(metricData))
                    .style("fill", color)
                    .style("fill-opacity", 0.35);

                // Linha de contorno
                blobWrapper.append("path")
                    .attr("d", radarLine(metricData))
                    .style("stroke-width", "3px")
                    .style("stroke", color)
                    .style("fill", "none");

                // Marcadores nos pontos (Dots)
                blobWrapper.selectAll(".dot")
                    .data(metricData).enter().append("circle")
                    .attr("r", 5)
                    .attr("cx", (d, i) => rScale(d.value) * Math.cos(angleSlice * i - Math.PI / 2))
                    .attr("cy", (d, i) => rScale(d.value) * Math.sin(angleSlice * i - Math.PI / 2))
                    .style("fill", color);
            });
        }

        // --- INICIALIZAÇÃO SEGURA ---
        function init() {
            try {
                if (typeof dscc !== 'undefined' && dscc.subscribeToData) {
                    // Assina para receber dados do Looker Studio
                    dscc.subscribeToData(drawViz, { transform: dscc.objectTransform });
                } else {
                    console.error("Aguardando biblioteca DSCC...");
                    setTimeout(init, 500);
                }
            } catch (e) {
                console.error("Erro na inicialização:", e);
            }
        }

        init();

        // Redesenha ao mudar o tamanho da janela
        window.addEventListener('resize', () => {
            // No Looker, o redimensionamento do componente dispara um novo envio de dados, 
            // mas o listener de resize ajuda na fluidez local.
            location.reload(); 
        });
    </script>
</body>
</html>
